import { Headers, Response as OriginalResponse } from '@whatwg-node/fetch';
export const LAZY_SERIALIZED_RESPONSE = Symbol('LAZY_SERIALIZED_RESPONSE');
export const defaultSerializer = obj => JSON.stringify(obj);
export function isLazySerializedResponse(response) {
    return response[LAZY_SERIALIZED_RESPONSE];
}
function isHeadersLike(headers) {
    return headers?.get && headers?.forEach;
}
const JSON_CONTENT_TYPE = 'application/json; charset=utf-8';
function getHeadersFromHeadersInit(init) {
    let headers;
    if (isHeadersLike(init)) {
        headers = init;
    }
    else {
        headers = new Headers(init);
    }
    if (!headers.has('content-type')) {
        headers.set('content-type', JSON_CONTENT_TYPE);
    }
    return headers;
}
export function createLazySerializedResponse(jsonObj, init = {}) {
    let actualResponse;
    let headers;
    function getHeaders() {
        if (headers == null) {
            headers = getHeadersFromHeadersInit(init.headers);
        }
        return headers;
    }
    return {
        jsonObj,
        get actualResponse() {
            return actualResponse;
        },
        [LAZY_SERIALIZED_RESPONSE]: true,
        init,
        resolveWithSerializer(serializer) {
            const serialized = serializer(jsonObj);
            init.headers = getHeaders();
            actualResponse = new OriginalResponse(serialized, init);
        },
        json() {
            return Promise.resolve(jsonObj);
        },
        get status() {
            return (init?.status || 200);
        },
        get headers() {
            return getHeaders();
        },
    };
}
// This allows us to hook into serialization of the response body
/**
 * The Response interface of the Fetch API represents the response to a request.
 * It contains the status of the response, as well as the response headers, and
 * an optional response body.
 *
 * @param body An object defining a body for the response. This can be null (which is the default value), or a Blob, BufferSource, FormData, Node.js Readable stream, URLSearchParams, or USVString object. The USVString is handled as UTF-8.
 * @param options An options object containing any custom settings that you want to apply to the response, or an empty object (which is the default value).
 *
 * @see https://developer.mozilla.org/en-US/docs/Web/API/Response
 */
export const Response = new Proxy(OriginalResponse, {
    get(OriginalResponse, prop, receiver) {
        if (prop === 'json') {
            return createLazySerializedResponse;
        }
        return Reflect.get(OriginalResponse, prop, receiver);
    },
});
